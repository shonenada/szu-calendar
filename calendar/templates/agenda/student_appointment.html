{% extends 'dashboard/base.html' %}

{% block htmlhead %}
{{ renderCss('styles/fullcalendar.min.css') | raw }}
{{ renderCss('styles/agenda.css') | raw }}
{% endblock %}

{% block breadcrumbs %}
<li>发布空闲时段</li>
{% endblock %}

{% block content_header %}
{% endblock %}

{% block content_body %}
<div class="mash"></div>
<div class="dialog">
  <form id="dialog-form">
  <div class="dialog-title">
    &nbsp;<span class="dialog-title-content"></span>
    <div class="pull-right">
      <a href="javascript:void(0);" class="dialog-btn-close">
        <i class="icon icon-remove"></i>
      </a>
    </div>
  </div>
  <div class="dialog-content"></div>
  <div class="dialog-foot">
    <div class="pull-right">
      <div id="show-event-dialog-foot" class="dialog-foot-div">
        <a href="javascript:void(0);" class="btn btn-danger dialog-btn-delete">删除</a>
        <a href="javascript:void(0);" class="btn btn-primary dialog-btn-close">关闭</a>
      </div>
      <div id="add-event-dialog-foot" class="dialog-foot-div">
        <a href="javascript:void(0);" class="btn btn-primary dialog-btn-confirm">添加</a>
        <a href="javascript:void(0);" class="btn btn-info dialog-btn-close">关闭</a>
      </div>
    </div>
  </div>
  </form>
</div>

<div id="calendar"></div>

<div class="pull-right" style="margin-bottom: 20px;">
  <button type="button" class="btn btn-success" id="saveAgenda">保存</button>
</div>
{% endblock %}

{% block bodyfoot %}
{{ renderJs('scripts/plugins/moment.min.js') | raw }}
{{ renderJs('scripts/plugins/fullcalendar.min.js') | raw }}
{{ renderJs('scripts/plugins/fullcalendar.lang.zh-cn.js') | raw }}
<script type="text/javascript">
$(function() {
  var hideDialog = function() {
    $('.dialog').fadeOut();
    $('.mash').fadeOut();
  }

  var showEventDetailDialog = function(calEvent, jsEvent, view) {
    currentClickEvent = event;
    $('.dialog-foot-div').hide();
    $('#show-event-dialog-foot').show();
    $('.dialog-foot').show();
    $('.dialog-title-content').html(event.title);
    var content = $('<div></div>');
    var startDiv = $('<span></span>')
                    .addClass('datetime-format')
                    .append(event.start.format('YYYY-MM-DD HH:mm:ss'));
    var endDiv = $('<span></span>')
                    .addClass('datetime-format')
                    .append(event.end.format('YYYY-MM-DD HH:mm:ss'));

    var visDiv = $('<div id="visiDiv"></div>');
    var visChosenList = $('<div id="visChosenList"></div>');
    for(idx in event.visibleGroups) {
      visChosenList.append('<span>' + event.visibleGroups[idx] + '</span>');
    }
    visDiv.append('可见分组：').append(visChosenList);

    content.append($('<div>时间：</div>').append(startDiv).append(' ~ ').append(endDiv))
           .append(visDiv)
           .append($('<div>工作简述：</div>').append(event.description));
    $('.dialog-content').html(content);
    $('.dialog').fadeIn();
    $('.mash').fadeIn();
  }

 var showTipDialog = function(title, content) {
    $('.dialog-foot').hide();
    $('.dialog-title-content').html(title);
    $('.dialog-content').html(content);
    $('.dialog').fadeIn();
    $('.mash').fadeIn();
  }

  var date = new Date();
  var d = date.getDate();
  var m = date.getMonth();
  var y = date.getFullYear();

  calendar = $('#calendar').fullCalendar({
    firstDay: 0,
    weekends: false,
    lang: 'zh-cn',
    header: {
      left: 'prev,next,today',
      center: 'title',
      right: 'month,agendaWeek',
    },
    height: 'auto',
    allDaySlot: false,
    minTime: '08:00:00',
    maxTime: '18:00:00',
    slotDuration: '00:05:00',
    defaultView: 'agendaWeek',
    defaultDate: y + '-' + (m+1) + '-' + (d+1),
    editable: false,
    eventLimit: false,
    selectable: false,
    selectHelper: false,
    events: function (start, end, timezone, callback) {
      var timer;
      $('#calendar').fullCalendar('removeEvents');
      $.ajax({
        url: "{{ urlFor('agenda.appoinment_timetable_json[get]') }}",
        type: 'get',
        dataType: 'json',
        data: {
          start: start.unix(),
          end: end.unix(),
        },
        beforeSend: function(){
          timer = setTimeout(function(){
            showTipDialog('数据加载中', '数据加载中，请耐心等候..');
          }, 500);
        },
        success: function(res) {
          callback(res);
          clearTimeout(timer);
          hideDialog();
        },
        error: function(res) {
          $G.flash.flash('服务器发生错误，请联系管理员', 'danger');
          clearTimeout(timer);
          hideDialog();
        }
      });
    },
    eventClick: function (calEvent, jsEvent, view) {
      showEventDetailDialog(calEvent, jsEvent, view);
    },
  });
});
</script>
{% endblock %}